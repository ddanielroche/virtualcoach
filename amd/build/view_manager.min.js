define(["jquery","core/ajax","core/fragment","core/templates","core/str","core/notification","core_calendar/events","core_calendar/modal_event_form","core_calendar/selectors","core_calendar/repository","mod_virtualcoach/repository"],function(a,b,c,d,e,f,g,h,i,j,k){h.prototype.reloadBodyContent=function(b){if(this.reloadingBody)return this.bodyPromise;this.reloadingBody=!0,this.disableButtons();var d={};return this.hasEventId()&&(d.eventid=this.getEventId()),this.hasStartTime()&&(d.starttime=this.getStartTime()),this.hasCourseId()&&(d.courseid=this.getCourseId()),this.hasCategoryId()&&(d.categoryid=this.getCategoryId()),"undefined"!=typeof b&&(d.formdata=b),d.location=a(".calendarwrapper").data("coach-id"),d.moduleid=a(".calendarwrapper").data("module-id"),d.courseid=a(".calendarwrapper").data("courseid"),this.bodyPromise=c.loadFragment("mod_virtualcoach","event_form",this.getContextId(),d),this.setBody(this.bodyPromise),this.bodyPromise.then(function(){this.enableButtons()}.bind(this)).fail(f.exception).always(function(){this.reloadingBody=!1}.bind(this)).fail(f.exception),this.bodyPromise},j.submitCreateUpdateForm=function(a){var c={methodname:"mod_virtualcoach_submit_create_update_form",args:{formdata:a}};return b.call([c])[0]},j.getEventById=function(a){var c={methodname:"mod_virtualcoach_get_calendar_event_by_id",args:{eventid:a}};return b.call([c])[0]},j.deleteEvent=function(a,c){"undefined"==typeof c&&(c=!1);var d={methodname:"mod_virtualcoach_delete_calendar_events",args:{events:[{eventid:a,repeat:c}]}};return b.call([d])[0]};var l={COACH_SELECTOR:'select[name="coach"]'},m=function(b){b=a(b),b.on("click",i.links.navLink,function(c){var d=b.find(i.wrapper),e=d.data("view"),f=d.data("courseid"),g=d.data("categoryId"),h=d.data("coach-id"),j=d.data("module-id"),k=a(c.currentTarget);"week"===e&&(p(b,k.attr("href"),k.data("year"),k.data("month"),k.data("day"),f,g,h,j),c.preventDefault())}),b.on("change",l.COACH_SELECTOR,function(){var c=a(this),d=c.val();o(b,d,null).then(function(){return b.find(l.COACH_SELECTOR).val(d)}).fail(f.exception)});var c=a("body");c.off(g.created),c.on(g.created,function(){o(b)}),c.off(g.deleted),c.on(g.deleted,function(){o(b)}),c.off(g.updated),c.on(g.updated,function(){o(b)}),c.off(g.eventMoved),c.on(g.eventMoved,function(){o(b)})},n=function(b,c,e,h,j,l,m,n,o){return q(b),o=o||b.find(i.wrapper),M.util.js_pending([b.get("id"),c,e,h,j,l,m,n].join("-")),k.getCalendarWeekData(c,e,h,j,l,m,n).then(function(a){return d.render(b.attr("data-template"),a)}).then(function(a,b){return d.replaceNode(o,a,b)}).then(function(){return a("body").trigger(g.viewUpdated),!0}).always(function(){return M.util.js_complete([b.get("id"),c,e,h,j,l,m,n].join("-")),r(b)}).fail(f.exception)},o=function(b,c,d){var e=b.find(i.wrapper),f=e.data("year"),g=e.data("month"),h=e.data("day"),j=e.data("module-id"),k=b.find(i.wrapper).data("courseid");return"undefined"==typeof c&&(c=a(l.COACH_SELECTOR).val()),"undefined"==typeof d&&(d=b.find(i.wrapper).data("categoryId")),n(b,f,g,h,k,d,c,j,null)},p=function(a,b,c,d,e,f,g,h,i){return n(a,c,d,e,f,g,h,i,null).then(function(){return b.length&&"#"!==b&&window.history.pushState({},"",b),arguments})},q=function(a){var b=a.find(i.containers.loadingIcon);b.removeClass("hidden")},r=function(a){var b=a.find(i.containers.loadingIcon);b.addClass("hidden")};return{init:function(a){m(a)},reloadCurrentWeek:o,changeWeek:p,refreshWeekContent:n}});